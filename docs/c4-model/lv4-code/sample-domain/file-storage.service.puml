@startuml
' ==============================================================================
' [Level 4] FileStorageService - Class Diagram
' ==============================================================================
' Package: @pioncorp/sample-domain
' Description: ì‚¬ìš©ì ê°œì¸ íŒŒì¼ ìŠ¤í† ë¦¬ì§€ ì„œë¹„ìŠ¤
'
' ğŸ”— ì½”ë“œ ê²½ë¡œ:
'    â€¢ packages/sample-domain/src/file-storage/file-storage.service.ts
'    â€¢ packages/sample-domain/src/file-storage/file-storage.types.ts
'
' ğŸ”„ ë™ê¸°í™” ê·œì¹™:
'    âœ… ì´ íŒŒì¼ ë³€ê²½ â†’ lv3 (sample-domain.puml) "File Storage Management" í™•ì¸
'    âœ… FileStorageService í´ë˜ìŠ¤ ë³€ê²½ ì‹œ ì´ ë‹¤ì´ì–´ê·¸ë¨ ì—…ë°ì´íŠ¸ í•„ìˆ˜
'
' ğŸ“ ë³€ê²½ ëŒ€ìƒ:
'    â€¢ FileStorageService í´ë˜ìŠ¤ (í•„ë“œ, ë©”ì„œë“œ)
'    â€¢ FileMetadata ì¸í„°í˜ì´ìŠ¤
'    â€¢ UploadFileInput, UpdateFileInput, FileListQuery DTO
'    â€¢ FileValidationError ì—ëŸ¬ í´ë˜ìŠ¤
'
' â¬†ï¸  Zoom Out: ../../lv3-components/sample-domain.puml
' ==============================================================================

skinparam classAttributeIconSize 0
skinparam classFontStyle bold
skinparam packageStyle rectangle
skinparam shadowing false
skinparam backgroundColor transparent

package "sample-domain" <<Rectangle>> #85BBF0 {

    class FileStorageService <<singleton>> <<injectable>> {
        - files: Map<string, StoredFile>
        - logger: Logger
        __constructor__
        + FileStorageService(logger: Logger)
        __methods__
        + uploadFile(userId: string, input: UploadFileInput): Promise<FileMetadata>
        + downloadFile(fileId: string, userId: string): Promise<DownloadResult | undefined>
        + listFiles(userId: string, query?: FileListQuery): Promise<FileMetadata[]>
        + updateFile(fileId: string, userId: string, input: UpdateFileInput): Promise<FileMetadata | undefined>
        + deleteFile(fileId: string, userId: string): Promise<boolean>
        __helpers__
        - validateFileSize(size: number): void
        - validateMimeType(mimeType: string): void
        - verifyOwnership(file: StoredFile, userId: string): void
        __storage__
        .. In-Memory Map ..
    }

    class FileMetadata <<interface>> {
        + id: string
        + userId: string
        + fileName: string
        + fileSize: number
        + mimeType: string
        + uploadedAt: Date
    }

    class UploadFileInput <<interface>> {
        + fileName: string
        + fileSize: number
        + mimeType: string
        + content: Buffer
    }

    class UpdateFileInput <<interface>> {
        + content: Buffer
    }

    class FileListQuery <<interface>> {
        + limit?: number
        + offset?: number
        + sortBy?: 'uploadedAt' | 'fileName' | 'fileSize'
        + order?: 'asc' | 'desc'
    }

    class StoredFile <<interface>> {
        + metadata: FileMetadata
        + content: Buffer
    }

    class FileValidationError <<error>> {
        + message: string
        + code: string
        __codes__
        â€¢ FILE_TOO_LARGE
        â€¢ INVALID_MIME_TYPE
        â€¢ FORBIDDEN
    }
}

package "shared-core" <<Rectangle>> #85BBF0 {
    class Logger {
        + info(message: string, context?: object): void
        + debug(message: string, context?: object): void
        + error(message: string, context?: object): void
        + child(prefix: string): Logger
    }
}

' ==============================================================================
' Relationships
' ==============================================================================

FileStorageService -right-> Logger : <<uses>>
FileStorageService .down.> FileMetadata : <<creates>>
FileStorageService .down.> FileMetadata : <<manages>>
FileStorageService .down.> UploadFileInput : <<accepts>>
FileStorageService .down.> UpdateFileInput : <<accepts>>
FileStorageService .down.> FileListQuery : <<accepts>>
FileStorageService ..> StoredFile : <<stores>>
FileStorageService ..> FileValidationError : <<throws>>

StoredFile *-- FileMetadata
StoredFile *-- "1" Buffer

' ==============================================================================
' Notes
' ==============================================================================

note right of FileStorageService #FFFFCC
  <b><size:14>Decorators</size></b>
  ---
  â€¢ singleton - Application-wide singleton
  â€¢ injectable - DI container injectable

  <b><size:14>Storage</size></b>
  ---
  â€¢ Map<string, StoredFile> (In-Memory)
  â€¢ Key: UUID v4 (fileId)
  â€¢ No persistence (dev/test only)

  <b><size:14>Lifecycle</size></b>
  ---
  â€¢ Created once per application
  â€¢ Resolved via tsyringe container
  â€¢ Auto-registered by decorators
end note

note bottom of FileMetadata #FFFFCC
  <b>UUID v4 ê¸°ë°˜ ID</b>
  uploadedAt: ìë™ ìƒì„± (new Date())

  ëª¨ë“  íŒŒì¼ì€ userIdë¡œ ì†Œìœ ì ì¶”ì 
end note

note bottom of UploadFileInput #FFFFCC
  <b>DTO (Data Transfer Object)</b>

  íŒŒì¼ ì—…ë¡œë“œ ì…ë ¥ ë°ì´í„°
  content: Buffer (íŒŒì¼ ë°”ì´ë„ˆë¦¬)
end note

note bottom of UpdateFileInput #FFFFCC
  <b>DTO (Data Transfer Object)</b>

  íŒŒì¼ ë®ì–´ì“°ê¸° ì…ë ¥ ë°ì´í„°
  ë©”íƒ€ë°ì´í„°ëŠ” ë³´ì¡´ë¨
end note

note bottom of FileListQuery #FFFFCC
  <b>DTO (Data Transfer Object)</b>

  íŒŒì¼ ëª©ë¡ ì¡°íšŒ ì¿¼ë¦¬
  ì •ë ¬ ë° í˜ì´ì§€ë„¤ì´ì…˜ ì§€ì›
end note

note as MethodDetails #FFFFCC
  <b><size:16>ë©”ì„œë“œ ìƒì„¸</size></b>
  ====
  <b>uploadFile()</b>
  â€¢ íŒŒì¼ í¬ê¸° ê²€ì¦ (MAX_FILE_SIZE = 10MB)
  â€¢ MIME íƒ€ì… ê²€ì¦ (í—ˆìš© ëª©ë¡)
  â€¢ UUID ìë™ ìƒì„±
  â€¢ uploadedAt ìë™ ì„¤ì •
  â€¢ Mapì— ì €ì¥
  â€¢ Logger ê¸°ë¡ (info)

  <b>downloadFile()</b>
  â€¢ fileIdë¡œ ì¡°íšŒ
  â€¢ ê¶Œí•œ ê²€ì¦ (userId ì¼ì¹˜)
  â€¢ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ undefined ë°˜í™˜
  â€¢ ê¶Œí•œ ì—†ìœ¼ë©´ FileValidationError throw (403)
  â€¢ metadata + content ë°˜í™˜

  <b>listFiles()</b>
  â€¢ userIdë¡œ í•„í„°ë§
  â€¢ ì •ë ¬ (uploadedAt/fileName/fileSize)
  â€¢ í˜ì´ì§€ë„¤ì´ì…˜ (limit, offset)
  â€¢ Logger ê¸°ë¡ (info, count)

  <b>updateFile()</b>
  â€¢ fileIdë¡œ ì¡°íšŒ
  â€¢ ê¶Œí•œ ê²€ì¦ (userId ì¼ì¹˜)
  â€¢ íŒŒì¼ í¬ê¸° ê²€ì¦
  â€¢ ë©”íƒ€ë°ì´í„° ë³´ì¡´ (fileName, mimeType, uploadedAt)
  â€¢ content ë° fileSizeë§Œ ì—…ë°ì´íŠ¸
  â€¢ Logger ê¸°ë¡ (info)

  <b>deleteFile()</b>
  â€¢ fileIdë¡œ ì¡°íšŒ
  â€¢ ê¶Œí•œ ê²€ì¦ (userId ì¼ì¹˜)
  â€¢ Map.delete() í˜¸ì¶œ
  â€¢ Logger ê¸°ë¡ (info)
  â€¢ boolean ë°˜í™˜ (true/false)
end note

MethodDetails .up. FileStorageService

' ==============================================================================
' Constants
' ==============================================================================

note as Constants #E1F5FE
  <b><size:16>ìƒìˆ˜</size></b>
  ====
  <b>MAX_FILE_SIZE</b>
  â€¢ 10MB (10 * 1024 * 1024 bytes)

  <b>ALLOWED_MIME_TYPES</b>
  â€¢ ì´ë¯¸ì§€: image/jpeg, image/png, image/gif, image/webp
  â€¢ PDF: application/pdf
  â€¢ ë¬¸ì„œ: application/msword, application/vnd.*, text/plain
end note

' ==============================================================================
' DI Container Relationship
' ==============================================================================

class "DI Container\n(tsyringe)" as DIContainer <<singleton registry>> #85BBF0 {
  + resolve<T>(token: string): T
  + register<T>(token: string, provider: Provider<T>): void
}

DIContainer -down-> FileStorageService : <<provides>>
DIContainer -down-> Logger : <<provides>>

note right of DIContainer
  <b>ìë™ ë“±ë¡</b>
  reflect-metadata + decorators

  <b>í•´ì†Œ ë°©ë²•</b>
  container.resolve(FileStorageService)
end note

note as SyncGuide #FFE0E0
  <b>âš ï¸  ë™ê¸°í™” ì²´í¬ë¦¬ìŠ¤íŠ¸</b>
  ====
  ì´ ë‹¤ì´ì–´ê·¸ë¨ ë³€ê²½ ì‹œ:

  â˜ packages/sample-domain/src/file-storage/
     file-storage.service.ts ì½”ë“œ ë™ê¸°í™” í™•ì¸

  â˜ ìƒˆë¡œìš´ ë©”ì„œë“œ ì¶”ê°€ ì‹œ
     lv3 (sample-domain.puml) "File Storage Management"
     ì„¤ëª… ì—…ë°ì´íŠ¸

  â˜ FileMetadata ì¸í„°í˜ì´ìŠ¤ í•„ë“œ ë³€ê²½ ì‹œ
     file-storage.types.ts í™•ì¸
end note

@enduml
